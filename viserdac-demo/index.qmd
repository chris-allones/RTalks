---
title: "<br>"
title-slide-attributes:
  data-background-image: "https://chris-allones.github.io/RTalks/viserdac-demo/img/bg_sem_3.jpg"
  data-background-size: "cover"
format: 
  revealjs:
    theme: [simple, custom.scss]
    preview-links: true
    code-fold: false
    code-summary: "code"
    chalkboard: true
    slide-number: true
    footer: "SEM: fundamentals and applications | link: bit.ly/viserdac-demo"
engine: knitr
from: markdown+emoji
editor: visual
---

```{r}
#| echo: false
#| include: false
knitr::opts_chunk$set(comment = "", collapse = TRUE)

## working directory
setwd("~/GitHub-repo/RTalks/viserdac-demo")

## Libraries
library(tidyverse)
library(readxl)
library(lavaan)
library(semPlot)
library(seminr)
library(janitor)
library(haven)

# data management
data <- haven::read_sav("data/HBAT.sav") |> 
  select(x6:x18) |>  
  select(-x15, -x17) |>  # removing variables with below acceptable MSA
  tibble() |> 
  clean_names()

hbat_data <- haven::read_sav("data/HBAT_SEM_NOMISSING.sav") %>% 
  select(JS1:SI4) %>% mutate_all(as.numeric)

```

## Outline

-   SEM growth in research applications

-   Steps in doing SEM

-   Basics of SEM

-   CB-SEM vs. PLS-SEM

## SEM growth in research applications {.center-text}

```{r}
#| echo: false
#| eval: false
read_excel("data/sem_articles.xlsx", sheet = 1) |> 
  mutate(subject_area = fct_reorder(subject_area, count)) |> 
  ggplot(aes(count, subject_area)) + 
  geom_col(fill = "#1d3557") +
  geom_text(aes(label = count), hjust = -0.5, size = 3) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 3e4)) +
  theme_minimal() +
  theme(plot.margin = margin(rep(20, 4)),
        plot.title = element_text(face = "bold"),
        axis.title.x = element_text(margin = margin(t=20))) +
  labs(title = "SEM related journal articles",
       subtitle = str_wrap("A total of 83,863 articles covering the period 1978-2023 found in the Scopus database", 70),
       x = "Number of articles indexed in the Scopus database",
       y = element_blank())

ggsave("img/sem_subject_area.jpeg", dpi = 300, width = 8, height = 7)
```

![](img/sem_subject_area.jpeg){fig-align="center" width="80%"}

## SEM growth in research applications {.center-text}

```{r}
#| echo: false
#| eval: false

read_excel("data/sem_articles.xlsx", sheet = 2) %>% 
  filter(year < 2023) %>% 
  ggplot(aes(year, count)) + 
  geom_line(linewidth= 1) +
  geom_text(data = . %>% filter(year > 2010),
            aes(label = count), hjust = -0.5, size = 3) +
  scale_x_continuous(expand = c(0, 0), limits = c(1975, 2030), 
                     breaks = c(seq(1975, 2020, 10), 2022)) +
  scale_y_continuous(limits = c(0, 15e3), breaks = seq(0, 15e3, 2500)) +
  theme_minimal() +
  theme(plot.margin = margin(rep(20, 4)),
        plot.title = element_text(face = "bold"),
        axis.title.y = element_text(margin = margin(r=20))) +
  labs(title = "Growth of SEM related journal articles",
       subtitle = str_wrap("A total of 83,863 articles covering the period 1978-2023 found in the Scopus database", 75),
       y = "Number of articles indexed in the Scopus database",
       x = element_blank())

ggsave("img/sem_time.jpeg", dpi = 300, width = 7, height = 5)
```

![](img/sem_time.jpeg){fig-align="center"}

## 

![](img/sample_sem_study.png){fig-align="center" width="80%" height="80%"}

::: source-text
Munim, Z. H., & Noor, T. (2020). Young people's perceived service quality and environmental performance of hybrid electric bus service. Travel Behaviour and Society, 20, 133--143. https://doi.org/10.1016/j.tbs.2020.03.003
:::

## Steps in doing SEM {.center-text}

<br>

![](img/sem_steps.png){.vertical-align fig-align="center" width="45%"}


##  {background-image="img/sem_steps_model_specs.png" data-background-size="80%" data-background-position="center" data-background-repeat="no-repeat"}

## Basics of SEM

::: columns
::: column
#### Measurement model

-   measurement part of a a full SEM model

-   confirmatory factor analysis
:::

::: column
![](img/measurement_part_2.jpg){fig-align="center"}
:::
:::

## Basics of SEM

::: columns
::: column
#### Measurement model

-   measurement part of a a full SEM model

-   confirmatory factor analysis

#### Structural model

-   relationship between constructs

-   full sem model is combination of measurement and structural component
:::

::: column
![](img/structural_part_2.jpg){fig-align="center"}
:::
:::

##  {background-image="img/sem_steps_estimation.png" data-background-size="80%" data-background-position="center" data-background-repeat="no-repeat"}

## Approaches in SEM {.center-text}

<br>

::: columns
::: column
### Covariance-based SEM (CB-SEM)

-   theory testing and confirmation
:::

::: column
### Partial least-square SEM (PLS-SEM)

-   prediction and theory development

:::
:::

<br>

::: center-text
*"Choice of the method originates from the goal of research. If the existing theory needs to be tested and confirmed, CB-SEM is the chosen one. Nevertheless, for theory development as well as prediction purposes, PLS-SEM is better."* - [Dash and Paul (2021)](https://doi.org/10.1016/j.techfore.2021.121092)

<br>

*"... both methods are complementary, not competitive"* - [Hair (2017)](https://www.inderscienceonline.com/doi/epdf/10.1504/IJMDA.2017.087624)
:::

## CB-SEM or PLS-SEM {.center-text}

![](img/cb_pls.png){fig-align="center" width="50%" height="50%"}

::: source-text
H., Hair Jr, F., J., Matthews, L.M., Matthews, R.L., Sarstedt, M., 2017. PLS-SEM or CBSEM: updated guidelines on which method to use. Int. J. Multivar. Data Anal. 1 (2), 107--123. https://doi.org/10.1504/IJMDA.2017.087624.
:::

# CB-SEM with Lavaan R package

## What is Lavaan?

::: columns
::: {.column width="40%"}
-   *"developed to provide useRs, researchers, and teachers a free open-source, but commercial quality"*, Yves Rosseel (2012)

-   Check-out this [lavaan tutorial](https://lavaan.ugent.be/tutorial/index.html)
:::

::: {.column width="60%"}
```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"
install.packages("lavaan")
library(lavaan)
example(cfa)
```

```{r}
#| echo: true
#| class-output: "remark-code"
library(lavaan)
example(cfa)
```
:::
:::

## Major operators of lavaan syntax

<br>

![](img/lavaan_syntax.jpg){fig-align="center" width="90%" height="90%"}

## Major operators of lavaan syntax

::: columns
::: column
#### Defining a reflective latent variable

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"
model <- "F1 =~ x1 + x2 + x3 + x4"
```

<br>

![](img/sample_syntax1.png){fig-align="center" width="45%" height="45%"}
:::

::: column
#### Estimate factor covariance

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x6 + x8
          F1 ~~ F2"
```

<br>

![](img/sample_syntax2.png){fig-align="center" width="90%" height="90%"}
:::
:::

## Major operators of lavaan syntax

::: columns
::: column
#### Estimate regression

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x7 + x8
          F3 =~ x9 + X10 + x11 + x12
          F1 ~~ F2
          F3 ~ F1 + F2"
```
:::

::: column
![](img/sample_syntax3.png){fig-align="center" width="80%" height="80%"}
:::
:::

## Major operators of lavaan syntax

::: columns
::: column
#### Insert a comment in the syntax

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x7 + x8
          F3 =~ x9 + X10 + x11 + x12
          
          # covariance
          F1 ~~ F2
          
          # F3 is regressed on F1 and F2
          F3 ~ F1 + F2"
```
:::

::: column
![](img/sample_syntax3.png){fig-align="center" width="80%" height="80%"}
:::
:::

## Major operators of lavaan syntax

::: columns
::: column
#### Label a parameter

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x7 + x8
          F3 =~ x9 + X10 + x11 + x12
          
          # covariance
          F1 ~~ F2
          
          # F3 is regressed on F1 and F2
          F3 ~ b1*F1 + b2*F2"
```
:::

::: column
![](img/sample_syntax4.png){fig-align="center" width="80%" height="80%"}
:::
:::

## Major operators of lavaan syntax

::: columns
::: column
#### Create a new parameter

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x7 + x8
          F3 =~ x9 + X10 + x11 + x12
          
          # regression
          F3 ~ b1*F1 + b2*F2
          F2 ~ b3*F1
          # F1 indirect effect
          ie := b3*b2
          # F1 total effect
          te := b3*b2 + b1"
```
:::

::: column
![](img/sample_syntax5.png){fig-align="center" width="80%" height="80%"}
:::
:::


## Structural model: estimation

::: columns
::: {.column width="40%"}
```{r}
#| echo: true
#| class-output: "remark-code"

sem_model <- "SI =~ SI1 + SI2 + SI3 + SI4
              JS =~ JS1 + JS2 + JS3 + JS4 + JS5
              AC =~ AC1 + AC2 + AC3 + AC4
              EP =~ EP1 + EP2 + EP3 + EP4
              OC =~ OC1 + OC2 + OC3 + OC4
              EP ~~ AC
              JS ~ H1*EP + H3*AC
              OC ~ H2*EP + H4*AC + H5*JS
              SI ~ H6*JS + H7*OC"
```

```{r}
#| echo: false
#| class-output: "remark-code"

cfa_model <- "SI =~ SI1 + SI2 + SI3 + SI4
              JS =~ JS1 + JS2 + JS3 + JS4 + JS5
              AC =~ AC1 + AC2 + AC3 + AC4
              EP =~ EP1 + EP2 + EP3 + EP4
              OC =~ OC1 + OC2 + OC3 + OC4"

cfa_fit <- cfa(cfa_model, data = hbat_data)
```
:::

::: {.column width="60%"}
```{r}
#| echo: true
#| eval: true
#| class-output: "remark-code-short"

sem_fit <- sem(model = sem_model, data = hbat_data)
summary(sem_fit, standardized = TRUE)

```
:::
:::


## Fit indices

::: columns
::: {.column width="40%"}
#### Goodness of fit indices

-   Goodness-of-fit index (GFI)
-   Adjusted goodness-fit-index (AGFI)
-   Comparative fit index (CFI)
-   Normed fit index (NFI)
-   Non-normed fit index (NNF)

#### Badness of fit indices

-   Standard root mean square of the residuals (SRMR)
-   Root mean square error of approximation (RMSEA)
:::

::: {.column width="60%"}
![](img/sample_gof.png)
:::
:::

::: aside
Sample GOF results from W. Shiau & M. Luo (2013). Continuance intention of blog users: The impact of perceived enjoyment, habit, user involvement and blogging time.
:::



## GOF measures between structural and CFA model

::: columns
::: {.column width="40%"}
```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"

gof_indices <- c('chisq', 'df','pvalue', "gfi", 
                 'rmsea', 'rmr', 'srmr', 'nfi', 
                 'nnfi', 'cfi', 'agfi')
fitmeasures(sem_fit, fit.measures = gof_indices)
fitmeasures(cfa_fit, fit.measures = gof_indices)
```

<br>

```{r}
#| echo: true
#| class-output: "remark-code"

gof_indices <- c('chisq', 'df','pvalue', "gfi", 
                 'rmsea', 'rmr', 'srmr', 'nfi', 
                 'nnfi', 'cfi', 'agfi')
fitmeasures(sem_fit, fit.measures = gof_indices)
fitmeasures(cfa_fit, fit.measures = gof_indices)
```
:::

::: {.column width="60%"}
![](img/fit_indices.png){fig-align="right"}
:::
:::

# PLS-SEM with SEMinR package

## 

::: columns
::: {.column width="60%"}
![](img/seminr_0.png){fig-align="left" width="40%" height="40%"}

-   *"SEMinR brings a friendly syntax to creating and estimating SEM. It uses its own PLS-SEM engine and integrates with the Lavaan package for CB-SEM/CFA estimation.* - Soumya Ray & Nicholas Danks (2020)

-   Check-out this [SEMinR vignette](https://cran.r-project.org/web/packages/seminr/vignettes/SEMinR.html)

-   Download the [PLS-SEM book using R](https://link.springer.com/content/pdf/10.1007/978-3-030-80519-7.pdf)
:::

::: {.column width="40%"}
![](img/seminr_00.png){fig-align="center" width="70%" height="70%"}
:::
:::

## What is SEMinR?

::: columns
::: {.column width="60%"}
#### Three main steps in using SEMinR

1.  Describe measurement model for each constructs and its items

2.  Describe the structural model of causal relationships between constructs

3.  Estimate the model using PLS, CB-SEM, or CFA
:::

::: {.column width="40%"}
:::
:::

## Major operators of SEMinR syntax

::: columns
::: column
#### 1. Describe measurement model for each constructs and its items

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"

model <- constructs(
  composite(construct_name = "F1", item_names = multi_items("x", 1:4)))

plot(model)
```

<br>

![](img/seminr_1.png){fig-align="center" width="45%" height="45%"}
:::

::: column
![](img/sample_syntax1.png){fig-align="center" width="45%" height="45%"}
:::
:::

## Major operators of SEMinR syntax

::: columns
::: column
#### 2. Describe the structural model of causal relationships between constructs

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"

## specifying measurement model
mm <- constructs(
  composite(construct_name = "F1", item_names = multi_items("x", 1:4)),
  composite("F2", multi_items("x", 5:8)),
  composite("F3", multi_items("x", 9:12)))

## specifying structural model
sm <- relationships(
  paths(from = "F1", to = "F2"),
  paths(from = c("F1", "F2"), to = "F3"))

plot(sm)

```

<br>

![](img/seminr_2.png){fig-align="center" width="45%" height="45%"}
:::

::: column
![](img/sample_syntax5.png){fig-align="center" width="80%" height="80%"}
:::
:::

## Major operators of SEMinR syntax

::: columns
::: column
#### 3. Estimate the model

```{r}
#| echo: false
#| eval: false
#| class-output: "remark-code"

# Data
hbat_data <- read_sav("data/HBAT_SEM_NOMISSING.sav") %>% 
 clean_names() %>% 
 select(js1:si4) %>%
 mutate_all(as.numeric) %>% 
 rename("x1" = "ac1",
        "x2" = "ac2",
        "x3" = "ac3",
        "x4" = "ac4",
        "x5" = "ep1",
        "x6" = "ep2",
        "x7" = "ep3",
        "x8" = "ep4",
        "x9" = "js1",
        "x10" = "js2",
        "x11" = "js3",
        "x12" = "js4"
        )

## specifying measurement model
mm <- constructs(
  composite(construct_name = "F1", item_names = multi_items("x", 1:4)),
  composite("F2", multi_items("x", 5:8)),
  composite("F3", multi_items("x", 9:12)))

## specifying structural model
sm <- relationships(
  paths(from = "F1", to = "F2"),
  paths(from = c("F1", "F2"), to = "F3"))



```

```{r}
#| echo: true
#| eval: false
#| class-output: "remark-code"

## specifying measurement model
pls_sem_estimate <- 
  estimate_pls(data = my_data,
             measurement_model = mm,
             structural_model = sm)

## plotting pls-sem model
plot(pls_sem_estimate)

```

![](img/seminr_3.png){fig-align="center" width="90%" height="90%"}
:::

::: column
![](img/sample_syntax5.png){fig-align="center" width="80%" height="80%"}
:::
:::


## Well done! {.center-text}

![](img/proud_of_you.gif)

## Sample analysis {.center-text}

::: columns
::: {.column .center-text width="50%"}
![](img/qr-cb-sem.png){fig-align="center" width="45%" height="45%"}

[CB-SEM](https://chris-allones.github.io/RTalks/dbm-special-lecture-2024/sem-samples/cb-sem-2024.html)
:::

::: {.column .center-text width="50%"}
![](img/qr-pls-sem.png){fig-align="center" width="45%" height="45%"}

[PLS-SEM](https://chris-allones.github.io/RTalks/dbm-special-lecture-2024/sem-samples/pls-sem-2024.html)
:::
:::
